<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FridgeMind ‚Äî Dashboard</title>
<style>
:root{
  --bg-main:#E6E6FA; /* lavender */
  --card:#F7F4FA;
  --pink:#FFB6C1; 
  --pink-gradient: linear-gradient(135deg, #FFB6C1, #FFC0CB);
  --mint:#A8E6CF;
  --red:#FF6B6B;
  --shadow:0 4px 14px rgba(0,0,0,0.08);
  --warn-bg:#FF6B6B;
}
body{
  margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background: var(--bg-main);
  color:#333; padding:0;
}
h1{ text-align:center; margin:6px 0 18px; color:#9B59B6; }
.wrap{ max-width:960px; margin:0 auto; padding:20px; display:flex; gap:20px; }
.sidebar{
  width:220px; background:#D8BFD8; border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:12px; height:90vh;
  position:fixed; top:20px; left:-240px; transition:0.3s; z-index:10;
}
.sidebar.show{ left:20px; }
.sidebar button{ padding:10px; border:none; border-radius:12px; cursor:pointer; font-weight:600; background:var(--pink); color:#fff; text-align:left; }
.sidebar button.delete{ background:var(--red); }
.main{ flex:1; margin-left:240px; transition:0.3s; display:flex; flex-direction:column; align-items:center; }
.card{ background:var(--card); border-radius:16px; padding:18px; box-shadow:var(--shadow); margin-bottom:20px; width:100%; max-width:500px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
input[type="text"], input[type="date"]{
  padding:10px 12px; border-radius:12px; border:1px solid #f3dbe2; font-size:14px; flex:1;
}
button.add-btn{ background:var(--pink); background-image: var(--pink-gradient); color:white; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
button.secondary{ background:var(--mint); color:#333; border:1px solid #f3dbe2; }
button.delete-btn{ background:var(--red); color:#fff; border:none; padding:8px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
button.restore-btn{ background:var(--mint); color:#333; border:none; padding:8px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
button:disabled{ opacity:.6; transform:none; cursor:default; }
.items{ display:flex; flex-direction:column; gap:10px; width:100%; max-width:500px; }
.item-card{ background:#fff; border-radius:12px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,.05); display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
.info{ display:flex; flex-direction:column; gap:6px; min-width:220px; }
.name{ font-weight:700; font-size:15px; }
.expiry{ color:#666; font-size:14px; }
.badge{ background:var(--warn-bg); color:#fff; padding:4px 10px; border-radius:999px; font-weight:700; font-size:12px; }
.suggest{ font-size:13px; color:#666; font-style:italic; }
.small{ font-size:12px; color:#777; }
.toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#222; color:#fff; padding:8px 14px; border-radius:999px; font-size:13px; z-index:999; }
.toggle-menu{ position:fixed; top:20px; left:20px; background:var(--pink); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; z-index:11; }
.test-notif{ position:fixed; top:20px; right:20px; background:var(--mint); color:#333; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; z-index:12; }
.analytics-panel{ background:#F0E6FA; border-radius:16px; padding:16px; margin-bottom:20px; box-shadow:var(--shadow); transition:0.3s; width:100%; max-width:500px; display:none; flex-direction:column; }
.analytics-header{ display:flex; justify-content:space-between; cursor:pointer; align-items:center; }
.analytics-content{ display:flex; gap:20px; flex-wrap:wrap; margin-top:10px; }
.analytics-card{ background:#fff; border-radius:12px; padding:12px 14px; box-shadow:0 2px 6px rgba(0,0,0,.08); flex:1 1 120px; text-align:center; }
.analytics-card h4{ margin:0 0 6px; font-size:14px; color:#666; }
.analytics-card p{ margin:0; font-weight:700; font-size:16px; color:#333; }
/* Reminder card */
.reminder-card{ background:#FFFAF0; border-radius:12px; padding:10px 12px; margin-top:10px; text-align:center; font-weight:600; color:#333; box-shadow:0 2px 6px rgba(0,0,0,.05); font-size:14px; }

  /* üì± Mobile Responsive Fixes */
@media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  .wrap {
    flex-direction: column;
    padding: 10px;
  }

  .main {
    margin-left: 0;
    padding: 10px;
  }

  .sidebar {
    width: 200px;
    left: -220px;
    height: 100vh;
  }
  .sidebar.show {
    left: 0;
  }

  .row {
    flex-direction: column;
    align-items: stretch;
  }

  input[type="text"], input[type="date"], button.add-btn {
    width: 100%;
    margin-bottom: 8px;
  }

  .item-card {
    flex-direction: column;
    align-items: flex-start;
  }

  .test-notif {
    top: 70px;  /* moves test notif below menu button */
    right: 10px;
  }

  h1 {
    font-size: 18px;
  }

  .analytics-content {
    flex-direction: column;
  }
}
  @media (max-width: 600px) {
  /* Profile panel: full width on mobile */
  #profilePanel {
    width: 100%;
    box-sizing: border-box;
    margin: 0;
    border-radius: 0;
  }
  #profilePanel input,
  #profilePanel select,
  #profilePanel button {
    width: 100%;
    margin-bottom: 8px;
  }

  /* Analytics panel: full width and stacked */
  .analytics-panel {
    width: 100% !important;
    padding: 12px;
  }
  .analytics-content {
    flex-direction: column;
    gap: 12px;
  }
  .analytics-card {
    width: 100%;
    text-align: left;
  }

  /* Reminder cards full width */
  .reminder-card {
    width: 100%;
  }
}


</style>
</head>
<body>

<button class="toggle-menu">‚ò∞ Menu</button>
<button class="test-notif" id="testNotifBtn">üîî Test Notification</button>

<div class="sidebar" id="sidebar">
  <button id="homeBtn">üè† Home / Dashboard</button>
  <button id="categoriesBtn">ü•õ Categories</button>
  <div id="categorySubmenu" style="display:none; flex-direction:column; gap:6px; margin-left:12px;">
    <button data-cat="Vegetables">ü•ï Vegetables</button>
    <button data-cat="Fruits">üçé Fruits</button>
    <button data-cat="Dairy">ü•õ Dairy</button>
    <button data-cat="Grains">üçö Grains</button>
    <button data-cat="Other">üç≤ Other</button>
  </div>
<!-- PROFILE SECTION -->
<button id="profileBtn">üë§ Profile</button>
<div id="profilePanel" style="display:none; flex-direction:column; gap:12px; padding:10px; background:#fff; border-radius:12px; margin-top:10px;">

  <!-- Shown when NOT logged in -->
  <div id="loginSection" style="display:flex; flex-direction:column; gap:8px;">
    <h4>üîë Login</h4>
    <input id="loginEmail" type="text" placeholder="Email üìß" />
    <input id="loginPassword" type="password" placeholder="Password üîí" />
    <button id="loginBtn" class="secondary">‚û°Ô∏è Login</button>

    <h4>üÜï Sign Up</h4>
    <input id="signupEmail" type="text" placeholder="Email üìß" />
    <input id="signupPassword" type="password" placeholder="Password üîí" />
    <button id="signupBtn" class="secondary">‚úçÔ∏è Sign Up</button>
  </div>

  <!-- Shown when logged in -->
  <div id="profileSection" style="display:none; flex-direction:column; gap:12px; text-align:center;">
    <div id="profileAvatar" style="font-size:40px;">üê∂</div>
    <div id="profileName" style="font-weight:700; font-size:16px; margin-top:4px;">User</div>
    <div id="profileEmail" style="font-size:13px; color:#666;">user@example.com</div>
    <button id="logoutBtn" class="delete">üö™ Logout</button>
  </div>
</div>

<div class="main">
  <h1>ü•ï FridgeMind ‚Äî Track Items</h1>

  <div class="card">
    <div class="row">
      <input id="itemName" type="text" placeholder="Enter item name üçÖ" />
      <input id="expiryDate" type="date" />
      <button id="addBtn" class="add-btn">‚ûï Add</button>
    </div>
  </div>

  <div id="itemList" class="items"></div>

  <!-- Analytics Panel -->
  <div class="analytics-panel" id="analyticsPanel">
    <div class="analytics-header">
      <h3>üìä Fridge Analytics</h3>
      <span id="toggleAnalytics" style="font-size:18px; cursor:pointer;">‚ñº</span>
    </div>
    <div class="analytics-content" id="analyticsContent"></div>
    <div id="dailyReminders"></div>
  </div>
</div>
  <!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdmGC5ys8KA97g4vQ19eOJTLLP_4v3G-k",
    authDomain: "fridge-server.firebaseapp.com",
    projectId: "fridge-server",
    storageBucket: "fridge-server.firebasestorage.app",
    messagingSenderId: "930593873346",
    appId: "1:930593873346:web:de19a9fafb4b482f228a5b",
    measurementId: "G-K65J2627HB"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // make these available to your existing script
  window.FM_FIREBASE = { auth, db };
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- CONFIG (keeps your old code intact while letting us disable backend push safely) ---
const FM_CONFIG = { ENABLE_BACKEND_PUSH:false };

// Pantry data
const pantry = {
  "tomato": { emoji:"üçÖ", recipes:["Tomato Chutney","Tomato Rasam","Tomato Rice"], expiry:7, category:"Vegetables" },
  "onion": { emoji:"üßÖ", recipes:["Onion Chutney","Onion Pakora","Onion Sambar"], expiry:10, category:"Vegetables" },
  "potato": { emoji:"ü•î", recipes:["Aloo Curry","Aloo Paratha","Jeera Aloo"], expiry:14, category:"Vegetables" },
  "carrot": { emoji:"ü•ï", recipes:["Carrot Halwa","Carrot Poriyal"], expiry:7, category:"Vegetables" },
  "bread": { emoji:"üçû", recipes:["Bread Upma","Bread Pakora"], expiry:3, category:"Grains" },
  "milk": { emoji:"ü•õ", recipes:["Make Paneer","Kheer"], expiry:3, category:"Dairy" },
  "curd": { emoji:"ü•õ", recipes:["Curd Rice","Raita"], expiry:5, category:"Dairy" },
  "rice": { emoji:"üçö", recipes:["Lemon Rice","Curd Rice"], expiry:180, category:"Grains" },
  "egg": { emoji:"ü•ö", recipes:["Egg Curry","Egg Bhurji"], expiry:10, category:"Other" },
  "paneer": { emoji:"üßÄ", recipes:["Paneer Butter Masala","Paneer Bhurji"], expiry:7, category:"Dairy" },
  "mango": { emoji:"ü•≠", recipes:["Mango Lassi","Mango Pickle"], expiry:5, category:"Fruits" },
  "apple": { emoji:"üçé", recipes:["Apple Halwa","Apple Juice"], expiry:10, category:"Fruits" },

  /* --- Added per your request: 10 South/North items (all under 'Other'), leftovers expire in 3 days --- */
  "idli batter": { emoji:"ü•û", recipes:["Steam Idlis","Uthappam"], expiry:3, category:"Other" },
  "dosa batter": { emoji:"ü•û", recipes:["Make Dosa","Uthappam"], expiry:3, category:"Other" },
  "sambar": { emoji:"ü•£", recipes:["Reheat Sambar","Mini Idli Sambar"], expiry:3, category:"Other" },
  "rasam": { emoji:"üç≤", recipes:["Reheat Rasam","Rasam Rice"], expiry:3, category:"Other" },
  "curd rice": { emoji:"üçö", recipes:["Reheat Curd Rice"], expiry:3, category:"Other" },
  "paneer butter masala": { emoji:"üç≤", recipes:["Reheat Paneer Butter Masala"], expiry:3, category:"Other" },
  "dal tadka": { emoji:"ü•ò", recipes:["Reheat Dal Tadka"], expiry:3, category:"Other" },
  "rajma": { emoji:"ü´ò", recipes:["Reheat Rajma"], expiry:3, category:"Other" },
  "chole": { emoji:"üçõ", recipes:["Reheat Chole"], expiry:3, category:"Other" },
  "roti": { emoji:"ü•Ø", recipes:["Reheat Roti","Make Rolls"], expiry:2, category:"Other" },
  "chapati": { emoji:"ü•Ø", recipes:["Reheat Chapati","Make Rolls"], expiry:2, category:"Other" }
};
/* Aliases (English + Tamil + Hindi + Telugu) */
const aliases = { 
  // Tomato
  "tomatoes":"tomato",
  "‡Æ§‡Æï‡Øç‡Æï‡Ææ‡Æ≥‡Æø":"tomato",   // Tamil
  "‡§ü‡§Æ‡§æ‡§ü‡§∞":"tomato",     // Hindi
  "tamatar":"tomato",
  "‡∞ü‡∞Æ‡±ã‡∞ü‡∞æ":"tomato",     // Telugu

  // Onion
  "onions":"onion",
  "‡Æµ‡ØÜ‡Æô‡Øç‡Æï‡Ææ‡ÆØ‡ÆÆ‡Øç":"onion",
  "‡§™‡•ç‡§Ø‡§æ‡§ú":"onion",
  "pyaz":"onion",
  "‡∞â‡∞≤‡±ç‡∞≤‡∞ø":"onion",

  // Potato
  "potatoes":"potato",
  "‡Æâ‡Æ∞‡ØÅ‡Æ≥‡Øà‡Æï‡Øç‡Æï‡Æø‡Æ¥‡Æô‡Øç‡Æï‡ØÅ":"potato",
  "‡§Ü‡§≤‡•Ç":"potato",
  "aloo":"potato",
  "‡∞¨‡∞Ç‡∞ó‡∞æ‡∞≥‡∞¶‡±Å‡∞Ç‡∞™":"potato",

  // Carrot
  "‡Æï‡Ææ‡Æ∞‡Æü‡Øç":"carrot",
  "‡§ó‡§æ‡§ú‡§∞":"carrot",
  "gajar":"carrot",
  "‡∞ï‡±ç‡∞Ø‡∞æ‡∞∞‡±Ü‡∞ü‡±ç":"carrot",

  // Milk
  "‡Æ™‡Ææ‡Æ≤‡Øç":"milk",
  "doodh":"milk",
  "‡§¶‡•Ç‡§ß":"milk",
  "‡∞™‡∞æ‡∞≤‡±Å":"milk",

  // Curd
  "‡Æ§‡ÆØ‡Æø‡Æ∞‡Øç":"curd",
  "‡§¶‡§π‡•Ä":"curd",
  "curd":"curd",
  "perugu":"curd",
  "‡∞§‡∞Ø‡∞ø‡∞∞‡±ç":"curd",

  // Rice
  "‡ÆÖ‡Æ∞‡Æø‡Æö‡Æø":"rice",
  "‡§ö‡§æ‡§µ‡§≤":"rice",
  "chawal":"rice",
  "‡∞¨‡∞ø‡∞Ø‡±ç‡∞Ø‡∞Ç":"rice",

  // Egg
  "‡ÆÆ‡ØÅ‡Æü‡Øç‡Æü‡Øà":"egg",
  "anda":"egg",
  "‡§Ö‡§Ç‡§°‡§æ":"egg",
  "‡∞ó‡±Å‡∞°‡±ç‡∞°‡±Å":"egg",

  // Paneer
  "‡Æ™‡Æ©‡ØÄ‡Æ∞‡Øç":"paneer",
  "paneer":"paneer",
  "‡§™‡§®‡•Ä‡§∞":"paneer",
  "‡∞™‡∞®‡±Ä‡∞∞‡±ç":"paneer",

  // Mango
  "‡ÆÆ‡Ææ‡ÆÆ‡Øç‡Æ™‡Æ¥‡ÆÆ‡Øç":"mango",
  "aam":"mango",
  "‡§Ü‡§Æ":"mango",
  "‡∞Æ‡∞æ‡∞Æ‡∞ø‡∞°‡∞ø":"mango",

  // Apple
  "‡ÆÜ‡Æ™‡Øç‡Æ™‡Æø‡Æ≥‡Øç":"apple",
  "seb":"apple",
  "‡§∏‡•á‡§¨":"apple",
  "‡∞Ü‡∞™‡∞ø‡∞≤‡±ç":"apple",

  // Leftovers
  "idly batter":"idli batter",
  "idlly batter":"idli batter",
  "dosai batter":"dosa batter",
  "dosa maavu":"dosa batter",
  "‡Æö‡Ææ‡ÆÆ‡Øç‡Æ™‡Ææ‡Æ∞‡Øç":"sambar",
  "rasam":"rasam",
  "‡Æ∞‡Æö‡ÆÆ‡Øç":"rasam",
  "‡§¶‡§æ‡§≤":"dal tadka",
  "‡§∞‡§æ‡§ú‡§Æ‡§æ":"rajma",
  "‡∞ö‡∞™‡∞æ‡∞§‡±Ä":"chapati",
  "rotis":"roti",
  "chapathi":"chapati",
  "chapatti":"chapati"
};


let allItems = JSON.parse(localStorage.getItem('allItems')||'[]');
let trash = JSON.parse(localStorage.getItem('trash')||'[]');
let currentPanel = 'home';

/* Added set for leftover names to auto-enforce 3-day expiry regardless of manual date */
const leftoverKeys = new Set(["idli batter","dosa batter","sambar","rasam","curd rice","paneer butter masala","dal tadka","rajma","chole"]);

// UI refs
const sidebar = document.getElementById('sidebar');
const toggleMenu = document.querySelector('.toggle-menu');
const itemNameInput = document.getElementById('itemName');
const expiryInput = document.getElementById('expiryDate');
const addBtn = document.getElementById('addBtn');
const itemList = document.getElementById('itemList');
const testNotifBtn = document.getElementById('testNotifBtn');
const analyticsPanel = document.getElementById('analyticsPanel');
const analyticsContent = document.getElementById('analyticsContent');
const dailyRemindersDiv = document.getElementById('dailyReminders');
const toggleAnalytics = document.getElementById('toggleAnalytics');
const homeBtn = document.getElementById('homeBtn');
const trashBtn = document.getElementById('trashBtn');
const expiryBtn = document.getElementById('expiryBtn');
const recipesBtn = document.getElementById('recipesBtn');
const categoriesBtn = document.getElementById('categoriesBtn');
const categorySubmenu = document.getElementById('categorySubmenu');
const analyticsBtn = document.getElementById('analyticsBtn');

// --- Helpers ---
function normalize(s){ return (s||"").toString().trim().toLowerCase(); }
function findPantryKeyFromLabel(label){ 
  if(!label) return null;
  const L = normalize(label);
  if(aliases[L]) return aliases[L];
  if(pantry[L]) return L;
  for(const key of Object.keys(pantry)){
    if(L.includes(key)) return key;
  }
  return null;
}
function daysUntil(dateStr){ 
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return 9999;
  const now = new Date();
  // Zero out time for stable comparison
  d.setHours(0,0,0,0); now.setHours(0,0,0,0);
  return Math.ceil((d - now)/(1000*60*60*24)); 
}
function showToast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}
function loadUserData() {
  allItems = JSON.parse(localStorage.getItem(`allItems_${userProfile.email}`) || '[]');
  trash = JSON.parse(localStorage.getItem(`trash_${userProfile.email}`) || '[]');
}
function saveUserData() {
  localStorage.setItem(`allItems_${userProfile.email}`, JSON.stringify(allItems));
  localStorage.setItem(`trash_${userProfile.email}`, JSON.stringify(trash));
}

// --- NOTIFICATION QUEUE + PERMISSION (Fix #1) ---
const _notifQueue = [];
let _notifBusy = false;
function ensureNotificationPermission(){
  if (!("Notification" in window)) return Promise.resolve(false);
  if (Notification.permission === "granted") return Promise.resolve(true);
  if (Notification.permission === "denied") return Promise.resolve(false);
  return Notification.requestPermission().then(p => p === "granted");
}
function _processNotifQueue(){
  if (_notifBusy || _notifQueue.length===0) return;
  _notifBusy = true;
  const {title, body} = _notifQueue.shift();
  try{
    new Notification(title, { body, icon:'https://i.imgur.com/8QfU5Yq.png' });
  }catch(e){ console.warn("Notification error:", e); }
  setTimeout(()=>{ _notifBusy=false; _processNotifQueue(); }, 900); // gentle spacing
}
function notifyDevice(title,msg){ 
  ensureNotificationPermission().then(ok => {
    if(!ok) return;
    _notifQueue.push({title, body:msg});
    _processNotifQueue();
  });
}
function playReminderSound(){ 
  try{
    const audio=new Audio('https://www.soundjay.com/button/beep-07.wav'); 
    audio.play().catch(()=>{});
  }catch(e){}
}

// --- Render Single Item (with multiple recipes dropdown) ---
function renderItem(obj){
  const card=document.createElement('div'); 
  card.className='item-card';
  const info=document.createElement('div'); 
  info.className='info';

  const dleft = daysUntil(obj.expiry);

  // Badge if near expiry
  if(dleft<=3 && !obj.deleted){ 
    const b=document.createElement('div'); 
    b.className='badge'; 
    b.textContent=`‚ö†Ô∏è Near Expiry (${dleft}d)`; 
    info.appendChild(b); 
  }

  // Item name
  const nameLine=document.createElement('div'); 
  nameLine.className='name'; 
  const emoji = pantry[obj.key]?.emoji || ''; 
  nameLine.textContent = `${emoji} ${obj.name}`; 
  info.appendChild(nameLine);

  // Expiry date
  const expLine=document.createElement('div'); 
  expLine.className='expiry'; 
  expLine.textContent=`Expires: ${obj.expiry}`; 
  info.appendChild(expLine);

  // üîΩ Multiple recipes dropdown
  if(obj.key && pantry[obj.key]?.recipes && pantry[obj.key].recipes.length > 0 && !obj.deleted){
    const toggle = document.createElement('button');
    toggle.textContent = "‚ñº Recipes";
    toggle.className = "secondary";
    toggle.style.marginTop = "6px";

    const recipeDiv = document.createElement('div');
    recipeDiv.style.display = "none";
    recipeDiv.style.flexDirection = "column";
    recipeDiv.style.gap = "4px";
    recipeDiv.style.marginTop = "4px";

    pantry[obj.key].recipes.forEach(r => {
      const link = document.createElement('a');
      link.href = `https://www.youtube.com/results?search_query=${r.replace(/ /g,'+')}`;
      link.target = "_blank";
      link.className = 'suggest';
      link.textContent = `üí° ${r}`;
      recipeDiv.appendChild(link);
    });

    toggle.onclick = () => {
      recipeDiv.style.display = recipeDiv.style.display === "none" ? "flex" : "none";
    };

    info.appendChild(toggle);
    info.appendChild(recipeDiv);
  }

  card.appendChild(info);

  // Buttons (delete/restore)
  const btns=document.createElement('div'); 
  btns.style.display='flex'; 
  btns.style.gap='6px'; 
  btns.style.flexDirection='column';

  if(!obj.deleted){ 
    const del=document.createElement('button'); 
    del.className='delete-btn'; 
    del.textContent='üóëÔ∏è Delete'; 
    del.onclick=()=>{ 
      obj.deleted=true; 
      trash.push(obj); 
      allItems=allItems.filter(i=>i!==obj); 
      saveUserData(); 
      renderCurrentPanel(); 
      showToast('Item moved to trash üóëÔ∏è'); 
    };
    btns.appendChild(del);
  } else { 
    const res=document.createElement('button'); 
    res.className='restore-btn'; 
    res.textContent='‚ôªÔ∏è Restore'; 
    res.onclick=()=>{ 
      obj.deleted=false; 
      allItems.push(obj); 
      trash=trash.filter(i=>i!==obj); 
      saveUserData(); 
      renderCurrentPanel(); 
      showToast('Item restored ‚ôªÔ∏è'); 
    };
    btns.appendChild(res);
  }

  card.appendChild(btns);
  return card;
}


// --- Render Panels ---
function renderCurrentPanel(){
  itemList.innerHTML='';
  analyticsPanel.style.display='none';
  dailyRemindersDiv.innerHTML='';
  if(currentPanel==='home'){ allItems.filter(i=>!i.deleted).forEach(i=>itemList.appendChild(renderItem(i))); }
  else if(currentPanel==='expiry'){ allItems.filter(i=>!i.deleted && daysUntil(i.expiry)<=3).forEach(i=>itemList.appendChild(renderItem(i))); }
  else if(currentPanel==='recipes'){ allItems.filter(i=>!i.deleted && daysUntil(i.expiry)<=3 && pantry[i.key]).forEach(i=>itemList.appendChild(renderItem(i))); }
  else if(currentPanel==='trash'){ trash.forEach(i=>itemList.appendChild(renderItem(i))); }
  else if(currentPanel==='analytics'){ analyticsPanel.style.display='flex'; renderAnalytics(); }
  else if(currentPanel==='categories'){ allItems.filter(i=>!i.deleted).forEach(i=>itemList.appendChild(renderItem(i))); }
}

// --- Analytics ---
function renderAnalytics(){
  const total=allItems.filter(i=>!i.deleted).length;
  const nearExp=allItems.filter(i=>!i.deleted && daysUntil(i.expiry)<=3).length;
  const byCat={}; for(const key in pantry) byCat[pantry[key].category]=0;
  allItems.forEach(i=>{ if(!i.deleted && pantry[i.key]) byCat[pantry[i.key].category]++; });
  analyticsContent.innerHTML='';
  analyticsContent.appendChild(createAnalyticsCard('Total Items',total));
  analyticsContent.appendChild(createAnalyticsCard('Near Expiry',nearExp));
  for(const cat in byCat) analyticsContent.appendChild(createAnalyticsCard(cat,byCat[cat]));

  // Daily Reminders
  dailyRemindersDiv.innerHTML='';
  allItems.filter(i=>!i.deleted).forEach(i=>{
    const card=document.createElement('div'); card.className='reminder-card';
    card.textContent=`${pantry[i.key]?.emoji||''} ${i.name} is lonely! Use it today üò∏`;
    dailyRemindersDiv.appendChild(card);
  });
}
function createAnalyticsCard(title,val){ const c=document.createElement('div'); c.className='analytics-card'; c.innerHTML=`<h4>${title}</h4><p>${val}</p>`; return c; }

// --- Add Item (Fix #2 immediate notifications, including near-expiry) ---
addBtn.onclick=()=>{
  const name=itemNameInput.value.trim();
  if(!name) return showToast('Please enter a name! üòø');
  const key = findPantryKeyFromLabel(name);
  const today=new Date();
  let expiry;

  /* Logic tweak: leftovers always auto-expire in 3 days (ignores manual date to keep you safe) */
  if(key && leftoverKeys.has(key)){
    expiry=new Date(); 
    expiry.setDate(today.getDate()+pantry[key].expiry); // 3 days
  } else if(expiryInput.value) {
    expiry=new Date(expiryInput.value);
  } else if(key && pantry[key]){ 
    expiry=new Date(); 
    expiry.setDate(today.getDate()+pantry[key].expiry); 
  } else { 
    expiry=today; 
    expiry.setDate(today.getDate()+7); 
  }

  const obj={ 
    name, 
    key, 
    expiry:expiry.toISOString().split('T')[0], 
    deleted:false 
  };
  allItems.push(obj);
  saveUserData();
  showToast(`Added ${name} ‚úÖ`);
  renderCurrentPanel();
  itemNameInput.value=''; expiryInput.value='';

 // Immediate queue notifications (Mobile Safe Fix)
if (Notification.permission !== "granted") {
  Notification.requestPermission().then(perm => {
    if (perm === "granted") {
      notifyDevice("FridgeMind", `Added ${name}`);
      playReminderSound();
      const dleft = daysUntil(obj.expiry);
      if (dleft <= 3) {
        notifyDevice("FridgeMind", `${name} is near expiry ‚ö†Ô∏è (${dleft} day${dleft===1?'':'s'})`);
      }
    } else {
      showToast("Notifications blocked ‚ùå");
    }
  });
} else {
  notifyDevice("FridgeMind", `Added ${name}`);
  playReminderSound();
  const dleft = daysUntil(obj.expiry);
  if (dleft <= 3) {
    notifyDevice("FridgeMind", `${name} is near expiry ‚ö†Ô∏è (${dleft} day${dleft===1?'':'s'})`);
  }
}
};

// --- Panel Switch ---
homeBtn.onclick=()=>{ currentPanel='home'; renderCurrentPanel(); }
expiryBtn.onclick=()=>{ currentPanel='expiry'; renderCurrentPanel(); }
recipesBtn.onclick=()=>{ currentPanel='recipes'; renderCurrentPanel(); }
trashBtn.onclick=()=>{ currentPanel='trash'; renderCurrentPanel(); }
analyticsBtn.onclick=()=>{ currentPanel='analytics'; renderCurrentPanel(); }
categoriesBtn.onclick=()=>{ categorySubmenu.style.display=categorySubmenu.style.display==='flex'?'none':'flex'; }
categorySubmenu.querySelectorAll('button[data-cat]').forEach(btn=>{
  btn.onclick=()=>{ const cat=btn.getAttribute('data-cat'); currentPanel='categories'; renderCurrentPanel(); itemList.innerHTML=''; allItems.filter(i=>!i.deleted && pantry[i.key]?.category===cat).forEach(i=>itemList.appendChild(renderItem(i))); };
});
toggleMenu.onclick=()=>{ sidebar.classList.toggle('show'); }
toggleAnalytics.onclick=()=>{ analyticsContent.style.display=analyticsContent.style.display==='flex'?'none':'flex'; }

// --- Test Notification (Mobile Safe Fix) ---
testNotifBtn.onclick = async () => {
  if (Notification.permission !== "granted") {
    const perm = await Notification.requestPermission();
    if (perm !== "granted") {
      alert("Notifications are blocked ‚ùå. Please enable them in your browser settings.");
      return;
    }
  }
  notifyDevice("FridgeMind", "This is a test notification!");
  playReminderSound();
};


// --- Near Expiry Notifications helper ---
function scheduleExpiryNotifications(){
  const nearExpItems=allItems.filter(i=>!i.deleted && daysUntil(i.expiry)<=3);
  nearExpItems.forEach(i=>{
    const msg=`${i.name} is near expiry ‚ö†Ô∏è`;
    notifyDevice('FridgeMind',msg);
  });
  if (nearExpItems.length) playReminderSound();
}

// --- Profile Feature ---
const profileBtn = document.getElementById('profileBtn');
const profilePanel = document.getElementById('profilePanel');
const profileName = document.getElementById('profileName');
const profileAvatar = document.getElementById('profileAvatar');
const profileEmail = document.getElementById('profileEmail');
const nameInput = document.getElementById('nameInput');
const emailInput = document.getElementById('emailInput');
const avatarSelect = document.getElementById('avatarSelect');
const saveProfileBtn = document.getElementById('saveProfileBtn');


  // --- Firebase Login Integration ---
const { auth, db } = window.FM_FIREBASE;
const loginForm = document.getElementById("loginSection");
const userInfo = document.getElementById("profileSection");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");


import { onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } 
  from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

// Auto switch UI if logged in/out
onAuthStateChanged(auth, (user) => {
  if (user) {
    loginForm.style.display = "none";
    userInfo.style.display = "flex";
    profileEmail.textContent = user.email;
    userProfile.email = user.email;   // keep your existing code happy
    loadUserData();
    renderCurrentPanel();
  } else {
    loginForm.style.display = "flex";
    userInfo.style.display = "none";
    profileEmail.textContent = "guest@example.com";
  }
});

// Login button
loginBtn.onclick = () => {
  signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value)
    .then(() => showToast("Logged in ‚úÖ"))
    .catch(err => showToast("Login failed ‚ùå " + err.message));
};

// Signup button
signupBtn.onclick = () => {
  createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value)
    .then(() => showToast("Account created üéâ"))
    .catch(err => showToast("Signup failed ‚ùå " + err.message));
};



// Load profile from localStorage
let userProfile = JSON.parse(localStorage.getItem('userProfile') || 
  '{"name":"Guest","email":"guest@example.com","avatar":"üê∂"}');

function renderProfile(){
  profileName.textContent = userProfile.name;
  profileEmail.textContent = userProfile.email;
  profileAvatar.textContent = userProfile.avatar;
  nameInput.value = userProfile.name;
  emailInput.value = userProfile.email;
  avatarSelect.value = userProfile.avatar;
}
renderProfile();
loadUserData();
  renderProfile();
loadUserData();

// --- Unified Logout (Firebase + Local Fallback) ---
const logoutBtn = document.getElementById("logoutBtn");

logoutBtn.onclick = () => {
  if (auth.currentUser) {
    // Firebase logout
    signOut(auth).then(() => {
      showToast("Logged out from Firebase üö™");
      allItems = [];
      trash = [];
      saveUserData();
      renderCurrentPanel();
    });
  } else {
    // Local fallback logout
    localStorage.removeItem('userProfile');
    userProfile = {name:"Guest", email:"guest@example.com", avatar:"üê∂"};
    allItems = [];
    trash = [];
    renderProfile();
    loadUserData();
    renderCurrentPanel();
    showToast("Logged out (Local) üö™");
  }
};


// Toggle profile panel
profileBtn.onclick = () => {
  profilePanel.style.display = profilePanel.style.display === 'flex' ? 'none' : 'flex';
};

// Save profile
saveProfileBtn.onclick = () => {
  userProfile.name = nameInput.value || "Guest";
  userProfile.email = emailInput.value || "guest@example.com";
  userProfile.avatar = avatarSelect.value;
  localStorage.setItem('userProfile', JSON.stringify(userProfile));
  renderProfile();
  loadUserData();       // load items for this email
  renderCurrentPanel(); // refresh UI
  showToast("Profile saved ‚úÖ");
};



// --- Clear Trash ---
const clearTrashBtn = document.getElementById('clearTrashBtn');
clearTrashBtn.onclick = () => {
  if(confirm("Are you sure you want to permanently clear all trash items?")) {
    trash = [];
    saveUserData();
    renderCurrentPanel();
    showToast("Trash cleared üßπ");
  }
};

// --- Init ---
ensureNotificationPermission().then(()=>{
  if(Notification.permission!=='granted') Notification.requestPermission();
});
renderCurrentPanel();

/* OLD schedule (kept, but commented to avoid double sends)
setInterval(()=>{
  const now=new Date();
  if(now.getHours()===9 || now.getHours()===18) scheduleExpiryNotifications();
},60*60*1000);
*/

// --- Daily Twice Notification at 06:00 and 12:00 while browser is open (Fix #3) ---
function _todayKey(prefix){ 
  const d=new Date(); 
  return `${prefix}-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; 
}
function _shouldRunSlot(slot){ 
  const k=_todayKey(`ran-${slot}`); 
  const ran=localStorage.getItem(k); 
  return !ran; 
}
function _markSlotRan(slot){ 
  const k=_todayKey(`ran-${slot}`); 
  localStorage.setItem(k,'1'); 
}
function _maybeRunTwiceDaily() {
  const now = new Date();
  const hh = now.getHours();
  const mm = now.getMinutes();

  // üåÖ Morning slot
  if (hh === 6 && mm === 0 && _shouldRunSlot('06')) {
    notifyDevice("FridgeMind", "üåÖ Morning check! Review near expiry items.");
    scheduleExpiryNotifications();
    _markSlotRan('06');
  }

  // ‚òÄÔ∏è Midday slot
  if (hh === 12 && mm === 0 && _shouldRunSlot('12')) {
    notifyDevice("FridgeMind", "‚òÄÔ∏è Midday check! Don‚Äôt forget your fridge items.");
    scheduleExpiryNotifications();
    _markSlotRan('12');
  }

  // reset flags after midnight
  if (hh === 0 && mm < 5) {
    localStorage.removeItem(_todayKey('ran-06'));
    localStorage.removeItem(_todayKey('ran-12'));
  }
}
setInterval(_maybeRunTwiceDaily, 60*1000);


// --- Push Subscription (kept in file but disabled by FM_CONFIG.ENABLE_BACKEND_PUSH) ---
async function registerPush() {
  if ("serviceWorker" in navigator && "PushManager" in window) {
    const reg = await navigator.serviceWorker.register("/sw.js");
    console.log("‚úÖ Service Worker registered");

    const publicKey = "BEHhptl6TQPR-yEiLJ6kZtxEdHcKAzkPIZSkBUb3nTfkoP34OaskQFwusCfcZvM48ayuHN_FTT2-Vvvp0L_rRc"; // your PUBLIC_VAPID_KEY

    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(publicKey)
    });

    await fetch("https://fridge-9m00.onrender.com/subscribe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: userProfile.email,   // dynamic: current logged-in user
        subscription: sub
      })
    });

    console.log("üì° Push subscription sent to backend");
  }
}

// helper to convert VAPID key
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}

// Call it once at startup (disabled unless you flip the flag)
if (FM_CONFIG.ENABLE_BACKEND_PUSH) {
  registerPush();
}

</script>

</body>
</html>




